# 後日談

ｱｶﾈﾁｬﾝｶﾜｲｲﾔｯﾀｰ

どうも朝早く起きてしまった (23時頃に宿に着き, 6時前くらいに目を覚ました).
2度寝しようとも思ったが, またそう思うと寝れないのも常のことだろう. 1時間ほど時間を持て余した今,
このまま過ごすのももったいないかと思い, 昨晩のことでも書いてみようかと思う. 実際,
興味深いことがあったのだ.

私は今回Rubyの構文を拡張したわけだが, これをtrunkにマージしてもらおうということは考えていなかった.
そもそも私は%記法自体役立つことはそこまで多くないだろうと考えている.
単に通常の文字列リテラルやヒアドキュメントが十分に強力だからである. この結論は, %記法を拡張し,
その後あれこれ思案しても結局は変わらなかった.

ところで昨晩はあるRubyコミッターが訪れており, こういったRubyについての興味深い話を聞き,
また私のどうしようもない愚痴も話すことができた. あの方が「かわいい」と思わないことにはこの変更は取り入れられないだろう,
と. そういうものなのか.

ともかく, せっかく話をできたのだからと, 私はRuby 3x3について聞いてみた. やれ遅いだの,
GILがあるだの言われるRubyだが, Web開発―そう, MastodonのためにRubyを使った私にはRubyといえばRailsでしかない―では,
I/Oが律速しているのであって, 現在のMastodon程度の規模ならSidekiqさえ使えばRuby自体には何ら不満はないのである.
Rubyは一体どこを目指しているのか… それに対する答えは, 予期されたとおり,「分からない」だった.

しかしそれは全く示唆がなかったことを意味しない. それからというものの,
やれ先に言ったようなRailsアプリケーションだとか, ERBだとか, JBuilderだとか,
そういった例を, 私がむやみに横槍を入れる中, 述べられたわけだが, その中で,
｢今まで (C言語などによる) Ruby拡張に頼っていたものをRubyで書けるようにする」という考えが現れたとき,
まさにそれだ, と思った.

その言い分はこうだ. 今Ruby拡張によって定義されたメソッドを呼び出すには大きなコストがかかり,
結果として中途半端にRuby拡張を呼び出すよりは全てRubyで書かれていたほうが効率が良い.
それゆえに全てRubyで書けるということは大きな利点だ, と.

それは違うと思った. それならRuby拡張を呼び出すコストを減らすべきなのだ. 実際,
私が今回Rubyの機能提案を実装しようとしたとき, 最初に注目したのは[より良いC APIのメソッド定義で性能を改善するというもの](https://bugs.ruby-lang.org/issues/13434)だった.
昨晩話をしたときは思い出せなかったが, 私はインタプリタの最適化を取り入れるため,
メソッド定義はRubyで行い, そのRubyのメソッドはより低級なインターフェイスを介して実装されるべきだろうと考えていた.
例えば次のような形である:

```Ruby
RubyVM::DL.new('/lib/libc.so').sym(:puts).call_c 'hello, world'
```

そして `RubyVM::DL::Symbol#call_c` などを最適化したバイトコードに置き換えることで,
高速化を狙う. ただ `RubyVM::DL::Symbol#call_c` は書き換えられることもあるだろうし,
そうなると[deoptimization engine](https://github.com/ruby/ruby/pull/1419)が必要になるが未だ取り入れられていないところを見て断念した.

話がそれたが, ともかく高速化でRubyで書けるものを増やすという考えは魅力的だと思った.
そういえば誰かがRubyの高速化を促すためにゲーム機のエミュレーターをRubyで実装したそうですね,
という話をしたら, 実際それは3倍早くなったのだと言う. またその方も高速化に取り組んだと.
なるほど, そういうことなのだ. 私は勝手に曲解した.

もう1つ, 面白い話があった. これは私を最初に今のバイト先に呼んだ人の話.
もっともこれは私的な話である.
